name: Build and Push Tool Images

on:
  pull_request:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  discover-tools:
    runs-on: ubuntu-latest
    outputs:
      tools: ${{ steps.tools.outputs.tools }}
    steps:
      - uses: actions/checkout@v4
      - id: tools
        run: echo "tools=$(./scripts/list_tools.sh)" >> "$GITHUB_OUTPUT"

  build-test-push:
    needs: discover-tools
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        tool: ${{ fromJson(needs.discover-tools.outputs.tools) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Read spec metadata
        id: spec
        shell: bash
        run: |
          set -euo pipefail
          spec="tools/${{ matrix.tool }}/spec.yml"

          image=$(ruby -ryaml -e 'puts YAML.load_file(ARGV[0]).fetch("image")' "$spec")
          tags_json=$(ruby -ryaml -rjson -e 'data=YAML.load_file(ARGV[0]); puts JSON.generate(data.fetch("tags", []))' "$spec")
          tests_json=$(ruby -ryaml -rjson -e 'puts JSON.generate(Array(YAML.load_file(ARGV[0]).fetch("test")))' "$spec")

          sha_tag="sha-${GITHUB_SHA::7}"

          tag_list=("$image:$sha_tag")
          while IFS= read -r t; do
            [[ -n "$t" ]] && tag_list+=("$image:$t")
          done < <(printf '%s' "$tags_json" | jq -r '.[]')

          {
            echo "image=$image"
            echo "sha_tag=$sha_tag"
            echo "tests_json=$tests_json"
            echo "tags_multiline<<EOF"
            printf '%s\n' "${tag_list[@]}"
            echo "EOF"
          } >> "$GITHUB_OUTPUT"

      - name: Build amd64 image for tests
        uses: docker/build-push-action@v6
        with:
          context: ./tools/${{ matrix.tool }}
          platforms: linux/amd64
          load: true
          tags: ${{ steps.spec.outputs.image }}:ci-${{ github.run_id }}-${{ matrix.tool }}

      - name: Run spec tests
        shell: bash
        run: |
          set -euo pipefail
          image="${{ steps.spec.outputs.image }}:ci-${{ github.run_id }}-${{ matrix.tool }}"
          printf '%s' '${{ steps.spec.outputs.tests_json }}' | jq -r '.[]' | while IFS= read -r cmd; do
            echo "Running test: $cmd"
            docker run --rm --entrypoint /bin/bash "$image" -lc "$cmd"
          done

      - name: Log in to Docker Hub
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Build and push multi-arch image
        if: github.event_name != 'pull_request' && github.ref == 'refs/heads/main'
        uses: docker/build-push-action@v6
        with:
          context: ./tools/${{ matrix.tool }}
          platforms: linux/amd64,linux/arm64
          push: true
          tags: ${{ steps.spec.outputs.tags_multiline }}
